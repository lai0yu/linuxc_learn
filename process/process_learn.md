# 进程

[toc]

## 概念

### 进程是什么

进程--进行中的程序
我们日常所使用的各种各样正在运行中的程序，对于操作系统来说就是一个或一组进程。当然现在应用程序比较复杂，一般来说运行一个程序往往会有很多个进程。

上述的说法不是很正确和严谨，但是是一个比较好的切入点，对于操作系统来说，进程是基本的任务单位。

<https://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html>

### 进程和程序的区别

* 进程是动态的概念，它是操作系统启动之后执行中的任务，是有生命周期的,
* 程序是静态的概念，是存放在磁盘上的可执行文件，存储了数据和指令。

### 进程和线程的区别

* 进程是操作系统分配资源的最小单位。
* 线程是CPU调度的最小单位。

### 进程的特点

* 独立性，各个进程有自己独立的内存空间，一般情况下互不干扰。
* 并发性，宏观上同时执行，微观上前后执行
* 动态性，进程是程序的执行过程

### 进程的分类

* 交互式进程：由shell或终端产生的进程
* 批处理进程：shell脚本
* 守护进程

## 使用shell命令查看系统进程

### 1.`ps -aux` 列出进程

ps：使用`ps --help all`可以查看参数意义
`top` 是动态展示，相当于任务管理器，每3秒刷新一次

![psaux](https://pic2.imgdb.cn/item/644d08100d2dde5777b3cf00.jpg)

* USER: 启动该进程的用户账号的名称
* PID: 进程ID
* VSZ：虚拟内存占用的大小
* TSS：内存的占用大小
* TTY：指进程的控制终端是哪个，'?'代表该进程和终端无关
* %CPU：CPU占用的百分比
* %MEM：内存占用的百分比
* TIME：占用CPU的时间片总时长(被挂起等不占用时间片的时间不算在内)
* START：启动该进程的时间
* STAT: 进程状态
  * D：无法中断的睡眠状态（通常IO的进程）
  * R：运行状态，正在执行中
  * T：中止状态，暂停执行
  * Z：僵死状态，不存在但暂时无法消除
  * I：多线程的状态
  * S：可中断的睡眠状态，等待某个事件发生后脱离该状态
  * W：没有足够的分页体可分配
  * <：高优先序的行程
  * N：低优先序的行程
  * L: 有记忆体分页分配并锁在记忆体内 (实时系统或 I/O)

### 2.`top`动态列出进程

每3秒刷新一次，相当于windows的任务管理器

### 3 `ps -al` 列出进程优先级

主要是`-l` 参数 能够列出优先级

![pi](https://pic2.imgdb.cn/item/644d1e700d2dde5777cfb639.jpg)

进程的调度优先级和PRI 和 PR 和 NI 这三个值有关，值越小，优先级越高，NI是面向用户级别的， 也叫谦让值(nice),用户可以通过renice命令修改它来影响优先级，nice的取值范围为(-20~19), PRI和PR是面向系统内核的，系统内核会根据调度算法频繁修改，

### 4 `kill 信号值 pid`

kill 将信号发送给指定pid的进程，它既是系统命令，也是一个函数，

* 通过 `man kill` 可以查看到该命令
* 通过 `man 2 kill`可以查看到该函数  

  ```c
  #include <sys/types.h>
  #include <signal.h>
  int kill(pid_t pid, int sig);
  ```

* 通过`kill -l` 可以查看可用的信号量，有些系统会带SIG前缀，本质是一样的
![kill](https://pic2.imgdb.cn/item/6450b93a0d2dde5777c4f5fc.jpg)

## Linux进程的实现

linux内核中用`struct task_struct`实现进程，在Ubuntu18.04上使用如下命令定位到进程的源码，

```shell
locate task
locate schedx
```

![task_struct_src_loccation](https://pic2.imgdb.cn/item/644cf63f0d2dde5777a0f556.jpg)

![task_struct_src](https://pic2.imgdb.cn/item/644cf68c0d2dde5777a13689.jpg=500x)

这个结构体原文共有700多行，难以完,全阅读，这个结构体很庞大，它同时也是一个很大很复杂的链表，准确来说，是多个链表，可以看到它指向了很多其他节点，靠到`struct list_head`，说明还使用了不止一个内核链表。
![task_list](https://pic2.imgdb.cn/item/644cf8180d2dde5777a272e5.jpg=500x)

linux内核的开发者使用这些链表是为了实现主要是为了实现进程的管理和调度。所以这个结构体也被称为PCB(process control block)，即进程控制块。

## 进程的常见概念

### 进程的并发

现代的操作系统基本上都是多任务的分时操作系统，多任务指的就是进程的并发，一个计算机啊操作系统可以"同时"运行多个进程，比如我们微信聊天的同时还能够用QQ音乐听歌。

但是准确来说，这两者并不是同时进行的，至少对于CPU来说不是，准确来说是分时的，由于cpu执行运算的速度特别快，所以计算机操作系统通过调度的方式不断的对进程进行cpu时间片轮转，达到人类无感知的任务切换，就好像计算机在同时处理这些进程一样。
这个分时指的就是cpu时间片的分时。

![cpu_turn](https://pic2.imgdb.cn/item/64524fb00d2dde57776adce7.jpg)

这种利用CPU时间片轮转多个进程一起处理，叫做进程并发。宏观上同时运行，微观上分时运行。

### 进程互斥

 进程互斥是指当有若干进程都要使用某一共享资源时，任何时候最多允许一个进程使用，其他要使用该资源的进程必须等待，直到进程使用者释放了该资源

### 进程同步

 一组并发进程按一定的顺序执行的过程称为进程间的同步。具有同步关系的一组并发进程称为合作进程，合作进程间互相发送的信号称为消息或事件。

### 临界资源

操作系统中将以此只允许一个进程访问的资源称为临界资源

### 临界区

进程中访问临界资源的那段程序代码称为临界区。为实现对临界资源的互斥访问，应保证诸进程互斥地进入各自的临界区。

## Linux下的特殊进程

1. 0号进程(init进程)
2. 1号进程(init进程)
3. 2号进程(kthread进程)
